class PaymentManager{mF9X(){this.paymentInProgress = false;this.apiBase = this.mD6S()? 'https::'https:this.isProd = this.mD6S();}mD6S(){return window.location.hostname === 'wocece.com';}async mUV7(testId,amount){if(this.paymentInProgress){this.mdCi('支付处理中，请稍候...');return;}if(!this.isProd && storageManager.TEST_MODE){this.mdCi('测试模式：已免费解锁测试');storageManager.savePaymentRecord(testId);setTimeout(()=>{window.location.href = `testing.html?id=${testId}`;},1000);return;}this.paymentInProgress = true;try{this.mdCi('即将跳转支付宝...');let vSG0 = await this.mMH1(testId,amount);let vFF8 ={testId:testId,timestamp:Date.now(),status:'pending',tradeNo:vSG0.tradeNo};sessionStorage.setItem('current_payment',JSON.stringify(vFF8));setTimeout(()=>{if(this.mV68()){this.mscr(vSG0.paymentUrl);}else{window.location.href = vSG0.paymentUrl;}},1500);}mLeH(error){console.error('支付失败:',error);this.mdCi('支付失败:' +(error.message || '请重试'));this.paymentInProgress = false;}}mV68(){return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);}mscr(paymentUrl){let vP4s = window.open('','_uH3');if(vP4s){vP4s.location.href = paymentUrl;}else{this.mfrg(paymentUrl);}}mfrg(paymentUrl){let vF56 = document.createElement('div');vF56.innerHTML = ` <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;"> <div style="background:white;padding:25px;border-radius:12px;max-width:320px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3);"> <h3 style="margin:0 0 15px 0;color:#333;">支付提示</h3> <p style="margin:0 0 15px 0;color:#666;line-height:1.5;">Safari浏览器需要允许弹出窗口才能跳转支付宝</p> <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;"> <button id="directPayBtn" style="padding:10px 20px;background:#1677FF;color:white;border:none;border-radius:6px;cursor:pointer;">直接跳转</button> <button id="cancelPayBtn" style="padding:10px 20px;background:#f5f5f5;color:#666;border:none;border-radius:6px;cursor:pointer;">取消</button> </div> <p style="margin:15px 0 0 0;font-size:12px;color:#999;">或复制链接在浏览器中打开</p> </div> </div> `;document.body.appendChild(vF56);vF56.querySelector('#directPayBtn').addEventListener('click',()=>{window.location.href = paymentUrl;vF56.remove();});vF56.querySelector('#cancelPayBtn').addEventListener('click',()=>{vF56.remove();this.paymentInProgress = false;});}async verifyPayment(testId){try{let vz34 = await fetch(`${this.apiBase}/verify-payment.php`,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({testId:testId,userId:this.mlk8()})});let vS54 = await vz34.json();if(vS54.success && vS54.paid){storageManager.savePaymentRecord(testId);return true;}return false;}mLeH(error){console.error('支付验证失败:',error);return false;}}mj06(testId,tradeNo){this.mdCi('测试环境：模拟支付流程');setTimeout(()=>{storageManager.savePaymentRecord(testId);this.mdCi('模拟支付成功！');setTimeout(()=>{window.location.href = `testing.html?id=${testId}`;},1500);this.paymentInProgress = false;},2000);}async mMH1(testId,amount){if(!this.isProd){return{tradeNo:'TEST_' + Date.now(),paymentUrl:'payment-success.html?testId=' + testId + '&success=true'};}let vz34 = await fetch(`${this.apiBase}/pay.php`,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({testId:testId,amount:amount,userId:this.mlk8()})});let vS54 = await vz34.json();if(!vz34.ok || !vS54.success){throw new Error(vS54.error || '创建订单失败');}return vS54;}mlk8(){let vLA9 = storageManager.getUserInfo().userId;if(!vLA9){vLA9 = 'user_' + Date.now()+ '_' + Math.random().toString(36).substr(2,9);storageManager.saveUserInfo({vLA9});}return vLA9;}mdCi(message){if(window.app && window.app.showToast){window.app.showToast(message);}else{let vl23 = document.createElement('div');vl23.style.cssText = ` position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:6px;z-index:2000;`;vl23.textContent = message;document.body.appendChild(vl23);setTimeout(()=>{vl23.remove();},2000);}}}window.paymentManager = new PaymentManager();