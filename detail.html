<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ‹è¯•è¯¦æƒ… - æˆ‘æµ‹æµ‹</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
            <div class="logo" onclick="window.history.back()">â† è¿”å›</div>
            <div class="nav-icon" onclick="shareManager.triggerShare()">â†—</div>
        </nav>

        <!-- æµ‹è¯•å°é¢ -->
        <div class="test-cover">
            <img id="testCoverImage" src="" alt="æµ‹è¯•å°é¢" class="cover-image">
            <h1 id="testTitle" class="test-title-main"></h1>
        </div>

        <!-- æµ‹è¯•æè¿° -->
        <section class="test-description">
            <div class="description-content">
                <p id="testDescription"></p>
            </div>
        </section>

        <!-- ç«‹å³æµ‹è¯•æŒ‰é’® -->
        <section class="action-section">
            <button id="startTestBtn" class="primary-btn">
                Â¥<span id="testPrice">1</span> è§£é”æµ‹è¯•
            </button>
            <div class="redeem-link">
                <a href="#" id="redeemLink">å·²æœ‰å…‘æ¢ç /ä¼˜æƒ ç ï¼Ÿç‚¹å‡»è¿™é‡Œ</a>
            </div>
        </section>

        <!-- é¡µè„š -->
        <footer style="text-align: center; padding: 20px; color: #666; font-size: 12px;">
            *æœ¬å°ç¨‹åºä»…ä¾›å¨±ä¹*
        </footer>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <div class="nav-item" data-target="index.html">
            <div class="nav-icon">ğŸ </div>
            <div>é¦–é¡µ</div>
        </div>
        <div class="nav-item" data-target="discover.html">
            <div class="nav-icon">ğŸ”</div>
            <div>å‘ç°</div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div class="toast"></div>

    <script src="js/app.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/payment.js"></script>
    <script src="js/share.js"></script>
    <script>
        class DetailManager {
            constructor() {
                this.testId = null;
                this.testData = null;
                this.init();
            }

            async init() {
                this.testId = new URLSearchParams(window.location.search).get('id');
                await this.loadTestData();
                this.renderTestDetail();
                this.bindEvents();
                
                // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆ†äº«æç¤º
                setTimeout(() => {
                    if (window.shareManager) {
                        window.shareManager.showShareTip();
                    }
                }, 1000);
            }

            async loadTestData() {
                // æ¨¡æ‹ŸAPIè°ƒç”¨è·å–æµ‹è¯•è¯¦æƒ…
                this.testData = {
                    id: this.testId,
                    title: 'æ€§æ ¼è‰²å½©æµ‹è¯•',
                    description: 'è¿™æ˜¯ä¸€ä¸ªåŸºäºå¿ƒç†å­¦åŸç†çš„æ€§æ ¼æµ‹è¯•ï¼Œé€šè¿‡10ä¸ªé—®é¢˜æ·±å…¥åˆ†æä½ çš„æ€§æ ¼ç‰¹ç‚¹ã€è¡Œä¸ºæ¨¡å¼å’Œæ½œåœ¨ä¼˜åŠ¿ã€‚æµ‹è¯•ç»“æœå°†å¸®åŠ©ä½ æ›´å¥½åœ°äº†è§£è‡ªå·±ï¼Œæ”¹å–„äººé™…å…³ç³»ï¼Œæå‡ä¸ªäººæˆé•¿ã€‚',
                    price: 1,
                    image: 'images/test-detail.jpg',
                    questions: 10,
                    category: 'standard'
                };
            }

            renderTestDetail() {
                document.getElementById('testCoverImage').src = this.testData.image;
                document.getElementById('testTitle').textContent = this.testData.title;
                document.getElementById('testDescription').textContent = this.testData.description;
                document.getElementById('testPrice').textContent = this.testData.price;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${this.testData.title} - æˆ‘æµ‹æµ‹`;
            }

            bindEvents() {
                // ç«‹å³æµ‹è¯•æŒ‰é’®
                document.getElementById('startTestBtn').addEventListener('click', () => {
                    this.handleStartTest();
                });

                // å…‘æ¢ç é“¾æ¥
                document.getElementById('redeemLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.goToRedeem();
                });

                // åˆ†äº«æŒ‰é’®
                document.querySelector('.nav-icon').addEventListener('click', () => {
                    if (window.shareManager) {
                        window.shareManager.triggerShare();
                    }
                });
            }

            handleStartTest() {
                // æ£€æŸ¥æ˜¯å¦å·²æ”¯ä»˜æˆ–å…è´¹æµ‹è¯•
                if (this.testData.price === 0 || storageManager.hasPaidForTest(this.testId)) {
                    // å…è´¹æµ‹è¯•æˆ–å·²æ”¯ä»˜ï¼Œç›´æ¥å¼€å§‹
                    window.location.href = `testing.html?id=${this.testId}`;
                } else {
                    // éœ€è¦æ”¯ä»˜
                    if (window.paymentManager) {
                        window.paymentManager.initializePayment(this.testId, this.testData.price);
                    } else {
                        // æ”¯ä»˜æœªå°±ç»ªæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
                        this.showToast('æ­£åœ¨å‡†å¤‡æ”¯ä»˜...');
                        setTimeout(() => {
                            window.location.href = `testing.html?id=${this.testId}`;
                        }, 1000);
                    }
                }
            }

            goToRedeem() {
                window.location.href = `redeem.html?testId=${this.testId}`;
            }
        }

        // åˆå§‹åŒ–è¯¦æƒ…é¡µ
        document.addEventListener('DOMContentLoaded', () => {
            window.detailManager = new DetailManager();
        });
    </script>

    <style>
        .test-cover {
            position: relative;
            margin: -15px -15px 20px -15px;
        }

        .cover-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .test-title-main {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 60px 20px 20px 20px;
            margin: 0;
            font-size: 24px;
        }

        .test-description {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .description-content {
            line-height: 1.8;
            color: #666;
        }

        .action-section {
            background: white;
            padding: 30px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            margin-bottom: 15px;
        }

        .redeem-link {
            margin-top: 10px;
        }

        .redeem-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
    </style>
</body>
</html>