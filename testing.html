<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>测试中 - 我测测</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="logo" onclick="window.history.back()">← 返回</div>
        </nav>
        <!-- 顶部进度条 -->
        <div class="testing-header">
            <div class="progress-text" id="progressText">第1题/共10题</div>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <!-- 题目区域 -->
        <section class="question-section">
            <div class="question-text" id="questionText"></div>
            <div class="question-image" id="questionImage"></div>
        </section>

        <!-- 选项区域 -->
        <section class="options-section">
            <div class="options" id="optionsContainer">
                <!-- 动态生成选项 -->
            </div>
        </section>

        <!-- 导航按钮 -->
        <section class="navigation-buttons">
            <button id="prevBtn" class="nav-btn prev-btn" disabled>上一题</button>
            <button id="nextBtn" class="nav-btn next-btn">下一题</button>
        </section>
    </div>

    <script src="js/storage.js"></script>
    <script>
        class TestingManager {
            constructor() {
                this.testId = null;
                this.testData = null;
                this.currentQuestionIndex = 0;
                this.answers = [];
                this.init();
            }

            async init() {
                this.testId = new URLSearchParams(window.location.search).get('id');
                await this.loadTestData();
                this.loadProgress();
                this.renderQuestion();
                this.bindEvents();
                this.updateNavigationButtons();
            }

            async loadTestData() {
                try {
                    // 从JSON文件加载测试数据
                    const response = await fetch('data/tests.json');
                    const data = await response.json();
                    this.testData = data.tests[this.testId];
                    
                    if (!this.testData) {
                        throw new Error('测试数据不存在');
                    }
                    
                    // 确保questions字段存在
                    if (!this.testData.questions || this.testData.questions.length === 0) {
                        throw new Error('测试题目数据为空');
                    }
                    
                } catch (error) {
                    console.error('加载测试数据失败:', error);
                    // 使用默认数据
                    this.testData = {
                        id: this.testId,
                        title: '心理测试',
                        questions: this.getDefaultQuestions()
                    };
                }
            }

            // 添加缺失的默认题目方法
            getDefaultQuestions() {
                return [
                    {
                        id: 1,
                        text: '当你遇到困难时，你通常会？',
                        image: null,
                        options: [
                            { id: 'A', text: '独自思考解决方案' },
                            { id: 'B', text: '寻求朋友帮助' },
                            { id: 'C', text: '暂时逃避问题' },
                            { id: 'D', text: '立即采取行动' }
                        ]
                    },
                    {
                        id: 2,
                        text: '在社交场合中，你更倾向于？',
                        image: null,
                        options: [
                            { id: 'A', text: '主动与人交流' },
                            { id: 'B', text: '等待别人来找你' },
                            { id: 'C', text: '观察周围环境' },
                            { id: 'D', text: '尽快离开' }
                        ]
                    },
                    {
                        id: 3,
                        text: '面对新的挑战，你的第一反应是？',
                        image: null,
                        options: [
                            { id: 'A', text: '兴奋和期待' },
                            { id: 'B', text: '谨慎评估风险' },
                            { id: 'C', text: '感到焦虑不安' },
                            { id: 'D', text: '寻找他人意见' }
                        ]
                    }
                ];
            }

            renderQuestion() {
                if (!this.testData || !this.testData.questions[this.currentQuestionIndex]) {
                    return;
                }

                const question = this.testData.questions[this.currentQuestionIndex];
                const progress = ((this.currentQuestionIndex + 1) / this.testData.questions.length) * 100;

                // 更新进度
                document.getElementById('progressText').textContent = 
                    `第${this.currentQuestionIndex + 1}题/共${this.testData.questions.length}题`;
                document.getElementById('progressBar').style.width = `${progress}%`;

                // 更新题目
                document.getElementById('questionText').textContent = question.text;

                // 更新图片
                const imageContainer = document.getElementById('questionImage');
                if (question.image) {
                    imageContainer.innerHTML = `<img src="${question.image}" alt="题目图片" style="max-width: 100%; border-radius: 8px;">`;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                }

                // 更新选项
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = question.options.map(option => {
                    const isSelected = this.answers[this.currentQuestionIndex] === option.id;
                    return `
                        <div class="option ${isSelected ? 'selected' : ''}" data-option-id="${option.id}">
                            <span class="option-label">${option.id}</span>
                            <span class="option-text">${option.text}</span>
                        </div>
                    `;
                }).join('');
            }

            bindEvents() {
                // 选项点击事件
                document.getElementById('optionsContainer').addEventListener('click', (e) => {
                    const option = e.target.closest('.option');
                    if (option) {
                        this.selectOption(option.dataset.optionId);
                    }
                });

                // 上一题按钮
                document.getElementById('prevBtn').addEventListener('click', () => {
                    this.previousQuestion();
                });

                // 下一题按钮
                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });

                // 防止页面刷新
                window.addEventListener('beforeunload', (e) => {
                    if (this.currentQuestionIndex > 0 && 
                        this.currentQuestionIndex < this.testData.questions.length - 1) {
                        e.preventDefault();
                        e.returnValue = '测试进度将会丢失，确定要离开吗？';
                    }
                });
            }

            selectOption(optionId) {
                // 记录答案
                this.answers[this.currentQuestionIndex] = optionId;
                
                // 重新渲染选项以显示选中状态
                this.renderQuestion();
                
                // 保存进度
                this.saveProgress();
                
                // 更新导航按钮状态
                this.updateNavigationButtons();
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.renderQuestion();
                    this.updateNavigationButtons();
                }
            }

            nextQuestion() {
                if (this.currentQuestionIndex < this.testData.questions.length - 1) {
                    // 如果有答案才允许进入下一题
                    if (this.answers[this.currentQuestionIndex]) {
                        this.currentQuestionIndex++;
                        this.renderQuestion();
                        this.updateNavigationButtons();
                    } else {
                        this.showToast('请先选择答案');
                    }
                } else {
                    // 最后一题，完成测试
                    if (this.answers[this.currentQuestionIndex]) {
                        this.completeTest();
                    } else {
                        this.showToast('请先选择答案');
                    }
                }
            }

            updateNavigationButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                // 更新上一题按钮状态
                prevBtn.disabled = this.currentQuestionIndex === 0;
                
                // 更新下一题按钮文本和状态
                if (this.currentQuestionIndex === this.testData.questions.length - 1) {
                    nextBtn.textContent = '完成测试';
                } else {
                    nextBtn.textContent = '下一题';
                }
                
                // 如果有答案，启用下一题按钮
                const hasAnswer = !!this.answers[this.currentQuestionIndex];
                nextBtn.disabled = !hasAnswer;
            }

            saveProgress() {
                const progress = {
                    testId: this.testId,
                    questionIndex: this.currentQuestionIndex,
                    answers: this.answers,
                    timestamp: Date.now()
                };
                storageManager.saveTestProgress(this.testId, progress);
            }

            loadProgress() {
                const progress = storageManager.getTestProgress(this.testId);
                if (progress) {
                    this.currentQuestionIndex = progress.questionIndex;
                    this.answers = progress.answers || [];
                }
            }

            completeTest() {
                // 计算结果
                const result = this.calculateResult();
                
                // 清除进度
                storageManager.clearTestProgress(this.testId);
                
                // 跳转到结果页
                const resultStr = encodeURIComponent(JSON.stringify(result));
                window.location.href = `result.html?id=${this.testId}&result=${resultStr}`;
            }

            calculateResult() {
                // 根据测试ID使用不同的计分逻辑
                if (this.testId === '6' && this.testData.dimensions) {
                    return this.calculateSCL90Result();
                } else {
                    return this.calculateDefaultResult();
                }
            }

            calculateSCL90Result() {
                // 检查维度数据是否存在
                if (!this.testData.dimensions) {
                    console.warn('SCL-90维度数据不存在，使用默认计分');
                    return this.calculateDefaultResult();
                }

                const dimensions = this.testData.dimensions;
                const result = {
                    score: 0,
                    dimensions: [],
                    testType: 'scl90',
                    totalScore: 0,
                    factorScores: {}
                };
                
                // 计算总分和因子分
                let totalScore = 0;
                let answeredCount = 0;
                
                this.answers.forEach((answer, index) => {
                    if (answer) {
                        const question = this.testData.questions[index];
                        const option = question.options.find(opt => opt.id === answer);
                        if (option && option.score) {
                            totalScore += option.score;
                            answeredCount++;
                        }
                    }
                });
                
                result.totalScore = totalScore;
                
                // 计算各维度分数
                Object.keys(dimensions).forEach(dimKey => {
                    const dimension = dimensions[dimKey];
                    let dimensionScore = 0;
                    let dimAnsweredCount = 0;
                    
                    // 计算该维度下所有题目的总分
                    dimension.items.forEach(questionNum => {
                        const answerIndex = questionNum - 1; // 题目编号从1开始，数组索引从0开始
                        if (this.answers[answerIndex]) {
                            const question = this.testData.questions[answerIndex];
                            const option = question.options.find(opt => opt.id === this.answers[answerIndex]);
                            if (option && option.score) {
                                dimensionScore += option.score;
                                dimAnsweredCount++;
                            }
                        }
                    });
                    
                    // 计算平均分（因子分）
                    const averageScore = dimAnsweredCount > 0 ? dimensionScore / dimAnsweredCount : 0;
                    
                    result.dimensions.push({
                        name: dimension.name,
                        score: Math.round((averageScore - 1) / 4 * 100), // 转换为百分制
                        analysis: dimension.description,
                        rawScore: dimensionScore,
                        averageScore: averageScore,
                        isHigh: averageScore > 2,
                        description: averageScore > 2 ? dimension.highDescription : dimension.lowDescription
                    });
                    
                    result.factorScores[dimKey] = averageScore;
                });
                
                // 计算总体评分（基于因子分的平均值转换为百分制）
                const totalAverage = result.dimensions.reduce((sum, dim) => sum + dim.averageScore, 0) / result.dimensions.length;
                result.score = Math.round((totalAverage - 1) / 4 * 100);
                
                // 生成总体评估
                result.overallAssessment = this.getSCL90Assessment(totalScore, result.factorScores);
                
                return result;
            }

            getSCL90Assessment(totalScore, factorScores) {
                let assessment = {
                    level: '正常',
                    description: '您的心理状态在正常范围内',
                    suggestion: '请继续保持良好的心理状态'
                };
                
                // 基于总分评估
                if (totalScore > 250) {
                    assessment.level = '严重';
                    assessment.description = '您的症状比较严重';
                    assessment.suggestion = '需要作医学上的详细检查，很可能要做针对性的心理治疗或在医生的指导下服药';
                } else if (totalScore > 200) {
                    assessment.level = '明显';
                    assessment.description = '您有明显心理问题的可能性';
                    assessment.suggestion = '可求助于心理咨询，进行专业的心理评估';
                } else if (totalScore > 160) {
                    assessment.level = '关注';
                    assessment.description = '您的总分超过临界值，建议关注';
                    assessment.suggestion = '应作进一步检查，关注自身心理健康状态';
                }
                
                // 检查是否有因子分超过2分
                const highFactors = Object.keys(factorScores).filter(key => factorScores[key] > 2);
                if (highFactors.length > 0) {
                    assessment.hasHighFactors = true;
                    assessment.highFactors = highFactors.map(key => this.testData.dimensions[key].name);
                    assessment.factorSuggestion = '部分因子分超过2分，建议重点关注这些方面的症状';
                }
                
                return assessment;
            }

            calculateDefaultResult() {
                // 简单的计分逻辑
                const scores = {
                    A: 0, B: 0, C: 0, D: 0
                };

                this.answers.forEach(answer => {
                    if (scores.hasOwnProperty(answer)) {
                        scores[answer]++;
                    }
                });

                const total = this.answers.length;
                const mainTrait = Object.keys(scores).reduce((a, b) => 
                    scores[a] > scores[b] ? a : b
                );

                return {
                    score: Math.floor((scores[mainTrait] / total) * 100),
                    mainTrait: mainTrait,
                    analysis: this.generateAnalysis(mainTrait),
                    dimensions: [
                        { name: '外向性', score: Math.floor(Math.random() * 40) + 60 },
                        { name: '宜人性', score: Math.floor(Math.random() * 40) + 60 },
                        { name: '尽责性', score: Math.floor(Math.random() * 40) + 60 },
                        { name: '情绪稳定性', score: Math.floor(Math.random() * 40) + 60 },
                        { name: '开放性', score: Math.floor(Math.random() * 40) + 60 }
                    ]
                };
            }

            generateAnalysis(trait) {
                const analyses = {
                    'A': '你是一个独立思考者，善于分析和解决问题。在压力下保持冷静，但有时可能过于独立。',
                    'B': '你重视人际关系，善于合作。能够很好地理解他人感受，但需要注意保持个人边界。',
                    'C': '你谨慎而敏感，善于观察细节。需要更多时间来适应变化，但思考问题很全面。',
                    'D': '你行动力强，果断坚决。善于把握机会，但需要注意考虑周全再行动。'
                };
                return analyses[trait] || '基于你的选择，这是一个个性化的分析结果。';
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 2000;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
        }

        // 初始化答题页面
        document.addEventListener('DOMContentLoaded', () => {
            window.testingManager = new TestingManager();
        });
    </script>

    <style>
        .testing-header {
            background: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .question-section {
            background: white;
            padding: 25px 20px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 18px;
            font-weight: bold;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .question-image {
            text-align: center;
            margin: 15px 0;
        }

        .options-section {
            margin-bottom: 20px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .option-label {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .option.selected .option-label {
            background: #764ba2;
        }

        .option-text {
            flex: 1;
            font-size: 16px;
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0 40px 0;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prev-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .prev-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            border-color: #e0e0e0;
            cursor: not-allowed;
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .next-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .question-text {
                font-size: 16px;
            }
            
            .option {
                padding: 12px;
            }
            
            .option-text {
                font-size: 14px;
            }
        }
    </style>
</body>
</html>